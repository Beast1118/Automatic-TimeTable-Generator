<!-- HTML: timetable.html -->
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dynamic Timetable</title>
  <style>
    body {
      font-family: Arial;
      padding: 20px;
      background-image: url("./Pictures/background1.jpg");
      color: white;
    }
    
    .container {
      margin-bottom: 40px;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 20px white;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th,
    td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }

    h3 {
      margin-bottom: 5px;
    }
  </style>
</head>

<body>
  <div id="timetableContainer"></div>

  <script>
    async function loadTimetable() {
      const startTime = localStorage.getItem("startTime");
      const endTime = localStorage.getItem("endTime");
      const classTime = parseInt(localStorage.getItem("classTime"));
      const divisions = parseInt(localStorage.getItem("number_of_division"));
      const totalRooms = parseInt(localStorage.getItem("number_of_rooms")) || 5;

      const response = await fetch("http://localhost:1000/api/teachers");
      const teachers = await response.json();

      const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday"];

      function timeToMinutes(t) {
        const [h, m] = t.split(":").map(Number);
        return h * 60 + m;
      }

      function minutesToTime(mins) {
        const h = Math.floor(mins / 60);
        const m = mins % 60;
        return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
      }

      function generateTimeSlots(start, end, duration, breaks = 2) {
        const slots = [];
        let startMin = timeToMinutes(start);
        const endMin = timeToMinutes(end);
        let count = 0;
        while (startMin + duration <= endMin) {
          let next = startMin + duration;
          slots.push({ start: minutesToTime(startMin), end: minutesToTime(next), type: "Class" });
          startMin = next;
          count++;
          if (breaks > 0 && count % 2 === 0) {
            let breakEnd = startMin + 30;
            slots.push({ start: minutesToTime(startMin), end: minutesToTime(breakEnd), type: "Break" });
            startMin = breakEnd;
            breaks--;
          }
        }
        return slots;
      }

      const slots = generateTimeSlots(startTime, endTime, classTime);
      const timetableDiv = document.getElementById("timetableContainer");
      timetableDiv.innerHTML = "";
      const assignedSlots = {}; // Track assigned teachers per timeslot

      for (let d = 0; d < divisions; d++) {
        const divKey = `Division ${String.fromCharCode(65 + d)}`;
        
        const section = document.createElement("section");
        section.className = "container";

        const heading = document.createElement("h3");
        heading.textContent = divKey;
        section.appendChild(heading);

        const table = document.createElement("table");
        table.innerHTML = `<thead><tr><th>Time</th>${days.map(day => `<th>${day}</th>`).join("")}</tr></thead><tbody></tbody>`;
        const tbody = table.querySelector("tbody");

        for (let i = 0; i < slots.length; i++) {
          const row = document.createElement("tr");
          const cell = document.createElement("td");
          const slot = slots[i];
          cell.textContent = `${slot.start} - ${slot.end}`;
          row.appendChild(cell);

          for (let j = 0; j < days.length; j++) {
            const cell = document.createElement("td");
            if (slot.type === "Break") {
              cell.textContent = "-- BREAK --";
            } else {
              const key = `${days[j]}-${i}`;
              assignedSlots[key] = assignedSlots[key] || new Set();

              let availableTeachers = teachers.filter(t => !assignedSlots[key].has(t.teacherID));

              if (availableTeachers.length === 0) {
                cell.textContent = "No Teacher Available";
              } else {
                const index = Math.floor(Math.random() * availableTeachers.length);
                const selectedTeacher = availableTeachers[index];

                assignedSlots[key].add(selectedTeacher.teacherID); // Prevent reuse at same time
                const roomNumber = `R${((i + j + d) % totalRooms) + 1}`;
                cell.innerHTML = `${selectedTeacher.name}<br>(${selectedTeacher.subject})<br><strong>${roomNumber}</strong>`;
              }
            }

            row.appendChild(cell);
          }

          tbody.appendChild(row);
        }

        section.appendChild(table);
        timetableDiv.appendChild(section);
      }
    }


    window.onload = loadTimetable;
  </script>
</body>

</html>